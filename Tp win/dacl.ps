# Import du module Active Directory
Import-Module ActiveDirectory

# Définition des variables
$userPwdReset = "ad_pwd_reset"
$groupDomainUsers = "Utilisateurs du domaine"  # Le nom correct en français
$groupITAdmins = "IT Admins"
$groupITTechs = "IT Techs"
$groupHRUsers = "HR Users"

# Ajout du droit ForceChangePassword pour ad_pwd_reset sur Utilisateurs du domaine
$acl = Get-Acl "AD:$(Get-ADGroup -Identity $groupDomainUsers)"
$sid = (Get-ADUser -Identity $userPwdReset).SID
$identity = [System.Security.Principal.IdentityReference]$sid
$adRights = [System.DirectoryServices.ActiveDirectoryRights]"ExtendedRight"
$type = [System.Security.AccessControl.AccessControlType]"Allow"
$extendedRightGuid = "00299570-246d-11d0-a768-00aa006e0529"

$aceForceChangePwd = New-Object System.DirectoryServices.ActiveDirectoryAccessRule `
    ($identity, $adRights, $type, [Guid]$extendedRightGuid)
$acl.AddAccessRule($aceForceChangePwd)
Set-Acl -AclObject $acl -Path "AD:$(Get-ADGroup $groupDomainUsers)"

# Ajout du droit GenericAll pour IT Admins sur IT Techs
$aclITTechs = Get-Acl "AD:$(Get-ADGroup $groupITTechs)"
$sidITAdmins = (Get-ADGroup $groupITAdmins).SID
$identityITAdmins = [System.Security.Principal.IdentityReference]$sidITAdmins
$aceGenericAll = New-Object System.DirectoryServices.ActiveDirectoryAccessRule `
    ($identityITAdmins, [System.DirectoryServices.ActiveDirectoryRights]"GenericAll", "Allow")
$aclITTechs.AddAccessRule($aceGenericAll)
Set-Acl -AclObject $aclITTechs -Path "AD:$(Get-ADGroup $groupITTechs)"

# Ajout du droit GenericAll pour IT Admins sur HR Users
$aclHRUsers = Get-Acl "AD:$(Get-ADGroup $groupHRUsers)"
$aceGenericAll = New-Object System.DirectoryServices.ActiveDirectoryAccessRule `
    ($identityITAdmins, [System.DirectoryServices.ActiveDirectoryRights]"GenericAll", "Allow")
$aclHRUsers.AddAccessRule($aceGenericAll)
Set-Acl -AclObject $aclHRUsers -Path "AD:$(Get-ADGroup $groupHRUsers)"

Write-Host "Les permissions ont été configurées avec succès." -ForegroundColor Green