# Configuration des DACLs sur le domaine
function Configure-DomainDACLs {
    try {
        # Import du module Active Directory
        Import-Module ActiveDirectory -ErrorAction Stop

        # Obtenir le domaine actuel
        $domain = Get-ADDomain
        $domainDN = $domain.DistinguishedName

        # 1. Ajouter le droit ForceChangePassword à ad_pwd_reset sur Utilisateurs du domaine
        $acl = Get-Acl "AD:CN=Utilisateurs du domaine,CN=Users,$domainDN"
        $sid = (Get-ADUser -Identity "ad_pwd_reset").SID
        $identity = [System.Security.Principal.IdentityReference]$sid
        $adRights = [System.DirectoryServices.ActiveDirectoryRights]"ExtendedRight"
        $type = [System.Security.AccessControl.AccessControlType]"Allow"
        $extendedRightGuid = [Guid]"00299570-246d-11d0-a768-00aa006e0529"

        $ace = New-Object System.DirectoryServices.ActiveDirectoryAccessRule `
            ($identity, $adRights, $type, $extendedRightGuid)
        
        $acl.AddAccessRule($ace)
        Set-Acl -AclObject $acl -Path "AD:CN=Utilisateurs du domaine,CN=Users,$domainDN"

        # 2. Ajouter GenericAll au groupe IT Admins sur IT Techs et HR Users
        foreach ($group in @("IT Techs", "HR Users")) {
            $ouPath = if ($group -eq "IT Techs") { "OU=IT" } else { "OU=HR" }
            $acl = Get-Acl "AD:CN=$group,$ouPath,OU=EXAM,$domainDN"
            $sid = (Get-ADGroup -Identity "IT Admins").SID
            $identity = [System.Security.Principal.IdentityReference]$sid
            $adRights = [System.DirectoryServices.ActiveDirectoryRights]"GenericAll"
            $type = [System.Security.AccessControl.AccessControlType]"Allow"

            $ace = New-Object System.DirectoryServices.ActiveDirectoryAccessRule `
                ($identity, $adRights, $type)
            
            $acl.AddAccessRule($ace)
            Set-Acl -AclObject $acl -Path "AD:CN=$group,$ouPath,OU=EXAM,$domainDN"
        }

        Write-Host "Configuration des DACLs terminée avec succès" -ForegroundColor Green
    }
    catch {
        Write-Error "Erreur lors de la configuration des DACLs: $_"
    }
}